version: '3'
name: 'ansys-rep'

volumes:
  minio-data:

services:

  traefik:
    image: traefik:v2.9
    container_name: traefik
    hostname: traefik
    restart: unless-stopped
    volumes:
     - ./config/certificates/traefik_pregen_certs.sh:/traefik_pregen_certs.sh
     - ./config/certificates:/certificates:rw
     - ./config/traefik/traefik.yaml:/etc/traefik/traefik.yaml:ro
     - ./config/traefik/dynamic:/etc/traefik/dynamic:ro
     - ${DOCKER_SOCK}:/var/run/docker.sock
    ports:
      - "${HOST_PORT}:443"
    command:
      - "./traefik_pregen_certs.sh"
      - "${EXTERNAL_NAME}"
    labels:   
      #/rep/traefik/dashboard gets you started with the UI, however the API calls dont seem to be changeable...
      #The referer header check allows all the api calls to be redirected properly as well (They aren't setup to goto /rep/consul/api from the webUI)
      traefik.http.routers.traefik.rule: PathPrefix(`/hps/traefik/dashboard`) || HeadersRegexp(`referer`, `.*hps/traefik/.*`)
      traefik.http.routers.traefik.entrypoints: external
      traefik.http.routers.traefik.service: api@internal
      traefik.http.routers.traefik.tls: true
      traefik.http.routers.traefik.priority: 100
      traefik.http.routers.traefik.middlewares: traefik-stripprefix
      traefik.http.middlewares.traefik-stripprefix.stripprefix.prefixes: /hps/traefik
      #However we want to use the api "normally" as well, so we need to route the path we want someone to use
      traefik.http.routers.traefik_api.rule: PathPrefix(`/hps/traefik/api`, `/hps/traefik/api`)
      traefik.http.routers.traefik_api.entrypoints: external
      traefik.http.routers.traefik_api.service: api@internal
      traefik.http.routers.traefik_api.priority: 100
      traefik.http.routers.traefik_api.middlewares: traefik_api-rep-stripprefix, traefik_api-hps-stripprefix
      traefik.http.middlewares.traefik_api-rep-stripprefix.stripprefix.prefixes: /rep/traefik
      traefik.http.middlewares.traefik_api-hps-stripprefix.stripprefix.prefixes: /hps/traefik

  minio:
    image: minio/minio:latest
    volumes:
      - minio-data:/data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=miniopassword
      - MINIO_BUCKET=data-transfer
    entrypoint: ["/bin/sh", "-c"]
    expose:
      - 9000
      - 9001
    command:
      - |
        minio server /data --console-address ":9001"
    labels:
      traefik.enable: true
      traefik.http.routers.minio.entrypoints: external
      traefik.http.routers.minio.rule: Host(`s3.${EXTERNAL_NAME}`)
      traefik.http.routers.minio.service: minio
      traefik.http.routers.minio.tls: true
      traefik.http.services.minio.loadbalancer.server.port: 9000

  minio-bucket:
    image: minio/mc:latest
    volumes:
      - minio-data:/data
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        sleep 1
        mc alias set minio http://minio:9000 minioadmin miniopassword
        mc mb minio/data-transfer
    depends_on:
      - minio

  dts:
    image: ${DOCKER_REPO}/rep/datad:${DTS_TAG}
    deploy:
      replicas: 1
    expose:
      - 1090
    command:
      - --config /app/config.json
      - --host=0.0.0.0 
      - -v 3
      - --docs
      - --external-url=https://${EXTERNAL_NAME}:${EXTERNAL_PORT}/hps/dts
    volumes:
      - ./config/dts/config.json:/app/config.json
    extra_hosts:
      - "s3.localhost:host-gateway"
    labels:
      traefik.http.routers.dts.rule: PathPrefix(`/rep/dts`, `/hps/dts`)
      traefik.http.routers.dts.tls: true
      traefik.http.routers.dts.priority: 100
      traefik.http.routers.dts.entrypoints: external
      traefik.http.routers.dts.middlewares: dts-rep-stripprefix,dts-hps-stripprefix
      traefik.http.middlewares.dts-rep-stripprefix.stripprefix.prefixes: /rep/dts
      traefik.http.middlewares.dts-hps-stripprefix.stripprefix.prefixes: /hps/dts
      traefik.http.services.dts.loadbalancer.server.port: 1090
      traefik.http.services.dts.loadbalancer.healthcheck.path: /api/v1
      traefik.http.services.dts.loadbalancer.healthcheck.interval: 5s
      traefik.http.services.dts.loadbalancer.healthcheck.timeout: 20s