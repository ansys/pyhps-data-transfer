#!/bin/bash

set -e

echo "CWD: $(pwd)"

models_dir=src/ansys/hps/data_transfer/client/models
url=https://localhost:8443/hps/dt/openapi.json

curl --insecure -L https://localhost:8443/hps/dt/openapi.json -o openapi.json

output=$models_dir/models.py

rm -rf $output || true

# We\re using custom templates to adjust how the enums look like
# Default templates can are at: https://github.com/koxudaxi/datamodel-code-generator/tree/82a929504db9d9ec587eed38130729b0079b02d1/src/datamodel_code_generator/model/template

extra_args="--use-default-kwarg --use-exact-imports --extra-fields allow --use-title-as-name --custom-template-dir=./scripts/templates"
datamodel-codegen --input openapi.json --http-ignore-tls --input-file-type auto --output $output --output-model-type pydantic_v2.BaseModel --custom-file-header "# generated by datamodel-codegen" $extra_args

sed_cmd=sed

if [ "$(uname)" == "Darwin" ]; then
    sed_cmd=gsed
fi


pushd $models_dir
$sed_cmd -i 's/remote: str/remote: str = "any"/' models.py
popd

for i in {1..5}
do
    echo "Running $i iteration"
    pre-commit run --all-files
    if [ $? -eq 0 ]
    then
        break
    fi
done
